#!/usr/bin/env bash

IMAGE="ghcr.io/cainiaocome/ai-in-container:main"
HOME_DIR_ON_HOST="$HOME/.homes_for_containers/copilot"
HOME_DIR_IN_CONTAINER="/home/ubuntu"
CONTAINER_NAME="ai-here-copilot"

# Ensure GH_TOKEN is provided
if [ -z "${GH_TOKEN:-}" ]; then
  echo "Error: GH_TOKEN environment variable is not set" >&2
  exit 1
fi

# Remove old container if exists
if [ "$(docker ps -aq -f name=^/${CONTAINER_NAME}$)" ]; then
  docker rm -f "${CONTAINER_NAME}"
fi

# Get current folder name and set subfolder path in container
SUBFOLDER_NAME="$(basename "$(pwd)")"
CONTAINER_WORKING_FOLDER="/app/${SUBFOLDER_NAME}"

# Check for --dev flag to change image tag
for arg in "$@"; do
  if [ "$arg" = "--dev" ]; then
    IMAGE="ghcr.io/cainiaocome/ai-in-container:dev"
    break
  fi
done

# Default: pass --resume to copilot; if --new or -n provided, do not pass --resume.
PASS_RESUME="--resume"
COPILOT_ARGS=()
for arg in "$@"; do
  case "$arg" in
  -n | --new) PASS_RESUME="" ;;
  --dev) ;;
  *) COPILOT_ARGS+=("$arg") ;;
  esac
done

docker run --rm -it \
  --name "${CONTAINER_NAME}" \
  -e GH_TOKEN \
  -v "$HOME_DIR_ON_HOST/:$HOME_DIR_IN_CONTAINER/" \
  -v "$(pwd):${CONTAINER_WORKING_FOLDER}" \
  -w "${CONTAINER_WORKING_FOLDER}" \
  "$IMAGE" \
  copilot --allow-all $PASS_RESUME "${COPILOT_ARGS[@]}"
